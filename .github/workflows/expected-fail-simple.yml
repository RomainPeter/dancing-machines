name: Expected Fail Demo (Simple)

on:
  push:
    branches: [ main, feature/* ]
  pull_request:
    branches: [ main ]

jobs:
  demo-s1-expected-fail:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install -r requirements.lock
          
      - name: Create test case with secret injection
        run: |
          mkdir -p test_secret_case
          cat > test_secret_case/secret_test.py << 'EOF'
          def process_data(data):
              # This should trigger OPA policy violation
              api_key = "sk-1234567890abcdef"  # SECRET INJECTED
              return data + api_key
          EOF
          
      - name: Run demo with expected failure
        run: |
          # This should fail with policy_violation
          python scripts/demo_simple.py || echo "Expected failure: demo completed with warnings"
            
      - name: Verify OPA policy triggered
        run: |
          # Check that we have the test case
          if [ -f "test_secret_case/secret_test.py" ]; then
            echo "✅ Test case created successfully"
          else
            echo "❌ Test case not created"
            exit 1
          fi
